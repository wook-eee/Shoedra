<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorate="~{layouts/layout1}">

<!-- ✅ CSS -->
<th:block layout:fragment="css">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .history-container {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px 16px;
            text-align: center;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        input[type="text"] {
            width: 90%;
            padding: 6px;
            font-size: 14px;
        }
        
        button {
            padding: 6px 12px;
            font-size: 14px;
            background-color: #3182f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .charge-label {
            color: #1976d2; /* 파란색 */
            font-weight: bold;
        }
        .refund-label {
            color: #e53935; /* 빨간색 */
            font-weight: bold;
        }
        .pay-label {
            color: #43a047; /* 초록색 */
            font-weight: bold;
        }
    </style>
</th:block>

<!-- ✅ 컨텐츠 -->
<div layout:fragment="content">
    <div class="history-container">
        <h1>캐시 충전 내역</h1>
        <table border="1">
            <thead>
            <tr>
                <!--                    <th>이름</th>-->
                <th>날짜</th>
                <th>금액</th>
                <th>결제 수단</th>
                <th>환불 사유</th>
                <th>환불 요청</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="history : ${cashList}">
                <!--                    <td th:text="${history.member.name}"></td>-->
                <td th:text="${#temporals.format(history.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                <td th:text="${history.amount} + '원'"></td>
                <td>
                    <span th:if="${history.method.name() == 'CHARGE'}" class="charge-label">충전</span>
                    <span th:if="${history.method.name() == 'REFUND'}" class="refund-label">환불</span>
                    <span th:if="${history.method.name() != 'CHARGE' and history.method.name() != 'REFUND'}" class="pay-label">결제</span>
                </td>
                <td>
                    <!-- CHARGE + 미환불: 입력란 -->
                    <input type="text"
                           th:id="'reason_' + ${history.id}"
                           th:if="${history.cashHistoryType.name() == 'CHARGE' and !history.refunded}"
                           placeholder="사유 입력" />
                    <!-- REFUND: 환불 완료 -->
                    <input type="text"
                           th:if="${history.cashHistoryType.name() == 'REFUND'}"
                           value="환불 완료"
                           readonly />
                </td>
                <td>
                    <!-- CHARGE + 미환불: 버튼 -->
                    <button th:if="${history.cashHistoryType.name() == 'CHARGE' and !history.refunded}"
                            th:attr="onclick=|requestRefund(${history.id})|">
                        환불 요청
                    </button>
                    <!-- REFUND: 완료됨 -->
                    <span th:if="${history.cashHistoryType.name() == 'REFUND'}">완료됨</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ✅ JavaScript -->
<th:block layout:fragment="script">
    <script>
        function requestRefund(historyId) {
            const reasonInput = document.getElementById('reason_' + historyId);
            const reason = reasonInput.value.trim();

            if (!reason) {
                alert("환불 사유를 입력해주세요.");
                return;
            }

            fetch('/cash/refund', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ historyId: historyId, reason: reason })
            })
            .then(res => {
                if (res.ok) {
                    alert('환불 요청이 접수되었습니다.');
                    // ✅ 새로고침으로 UI 반영
                    location.reload();
                } else {
                    alert('환불 요청에 실패했습니다.');
                }
            })
            .catch(err => {
                alert('요청 중 오류가 발생했습니다.');
                console.error(err);
            });
        }
    </script>
</th:block>
</html>
