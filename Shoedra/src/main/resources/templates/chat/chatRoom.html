<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…ë°©</title>
    <!-- CSRF í† í° meta íƒœê·¸ ì¶”ê°€ -->
    <meta th:name="_csrf" th:content="${_csrf.token}"/>
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chat-header {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .chat-header .type {
            font-size: 1rem;
            margin-top: 5px;
            color: #e0e0e0;
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        .message {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            max-width: 70%;
        }
        .message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-radius: 18px 18px 0 18px;
            padding: 10px 15px;
        }
        .message.admin {
            align-self: flex-start;
            background: #ffb74d;
            color: #333;
            border-radius: 18px 18px 18px 0;
            padding: 10px 15px;
        }
        .message.bot {
            align-self: flex-start;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 18px 18px 18px 0;
            padding: 10px 15px;
        }
        .message.system {
            align-self: center;
            background: #f8f9fa;
            color: #6c757d;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.95em;
        }
        .sender-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 2px;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        .message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .send-btn, .end-chat-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .send-btn {
            background: #667eea;
            color: white;
        }
        .end-chat-btn {
            background: #e74c3c;
            color: white;
            margin-top: 10px;
            width: 100%;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #2196f3;
            animation: typing 1.4s infinite ease-in-out;
        }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2 th:text="${chatRoom?.roomName ?: 'ì±„íŒ…ë°©'}">ì±„íŒ…ë°©</h2>
            <div class="type" th:text="${chatRoom?.chatType == '1:1' ? '1:1 ìƒë‹´' : 'ì±—ë´‡ ìƒë‹´'}">ìƒë‹´ ìœ í˜•</div>
        </div>

        <!-- 1:1 ìƒë‹´ë°©ì—ì„œ ê´€ë¦¬ì ìƒë‹´ì¤‘ ì•ˆë‚´ë¬¸êµ¬ -->
        <div th:if="${adminInProgressMsg}" style="background:#fff3cd;color:#856404;padding:12px 18px;margin:10px 0;border-radius:8px;border:1px solid #ffeeba;font-size:1.1em;text-align:center;">
            <span th:text="${adminInProgressMsg}"></span>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ ë Œë”ë§ -->
            <div th:each="msg : ${messages}"
                 th:class="'message ' + (${msg.senderType} == 'ADMIN' ? 'admin' : (${msg.senderType} == 'BOT' ? 'bot' : 'user'))">
                <div th:text="${msg.message}"></div>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-group">
                <input type="text" class="message-input" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <button class="send-btn" id="sendButton">ì „ì†¡</button>
            </div>
            <!-- ê´€ë¦¬ììš©: ìƒë‹´ì¢…ë£Œí›„ ì±„íŒ…ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ -->
            <button class="end-chat-btn" id="endChatButton"
                th:if="${#authorization.expression('hasRole(''ADMIN'')')}"
                onclick="window.location.href='http://localhost/admin/chat/in-progress'">
                ìƒë‹´ì¢…ë£Œí›„ ì±„íŒ…ë¦¬ìŠ¤íŠ¸
            </button>
            <!-- ìœ ì €ìš©: ìƒë‹´ì¢…ë£Œí›„ ì´ì „í˜ì´ì§€ ë²„íŠ¼ -->
            <button class="end-chat-btn" id="userBackButton"
                th:if="${!#authorization.expression('hasRole(''ADMIN'')')}"
                onclick="history.back()">
                <i class="fas fa-arrow-left"></i> ìƒë‹´ì¢…ë£Œí›„ ì´ì „í˜ì´ì§€
            </button>
        </div>
    </div>

    <!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script th:inline="javascript">
        // ì±„íŒ…ë°© ë°ì´í„°
        const chatRoomData = {
            id: [[${chatRoom?.id}]],
            chatType: '[[${chatRoom?.chatType}]]',
            roomName: '[[${chatRoom?.roomName}]]'
        };
        
        const currentUser = '[[${currentUserName}]]';
        let stompClient = null;
        
        // DOM ìš”ì†Œ
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const endChatButton = document.getElementById('endChatButton');
        const userBackButton = document.getElementById('userBackButton');
        const chatMessages = document.getElementById('chatMessages');
        
        function stripQuotes(str) {
            return typeof str === 'string' ? str.replace(/^"(.*)"$/, '$1') : str;
        }
        chatRoomData.chatType = stripQuotes(chatRoomData.chatType);
        chatRoomData.roomName = stripQuotes(chatRoomData.roomName);
        console.log('chatRoomData:', chatRoomData); // ê°’ í™•ì¸ìš©
        
        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            if (chatRoomData.chatType === 'CHATBOT' || chatRoomData.chatType === 'ì±—ë´‡' || chatRoomData.chatType === 'ì±—ë´‡ìƒë‹´' || chatRoomData.chatType === '2') {
                addMessage(message, 'user', currentUser);
                messageInput.value = '';
                
                // íƒ€ì´í•‘ í‘œì‹œ
                showTypingIndicator();
                
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = getBotResponse(message);
                    addMessage(response, 'bot', 'ì±—ë´‡');
                }, 1000);
            } else {
                console.log("stompClient:?"+stompClient);
                if (stompClient && stompClient.connected) {
                    stompClient.send("/app/chat.room.message", {}, JSON.stringify({
                        type: 'MESSAGE',
                        roomId: chatRoomData.id,
                        sender: currentUser,
                        message: message,
                        timestamp: new Date()
                    }));
                    messageInput.value = '';
                }
            }
        }
        
        // ë©”ì‹œì§€ ì¶”ê°€ (senderTypeì— ë”°ë¼ ë§í’ì„ )
        function addMessage(content, senderType, senderName) {
            console.log('addMessage í˜¸ì¶œ:', {content, senderType, senderName});
            if (!content || content.trim() === '') return; // ë¹ˆ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ
            const chatMessages = document.getElementById('chatMessages'); // í•­ìƒ ìµœì‹  ì°¸ì¡°
            if (!chatMessages) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${senderType}`;
            if (senderType === 'user' || senderType === 'admin' || senderType === 'bot') {
                messageDiv.innerHTML = `<div>${content.replace(/\n/g, '<br>')}</div>`;
            } else if (senderType === 'system') {
                messageDiv.innerHTML = `<div>${content.replace(/\n/g, '<br>')}</div>`;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // íƒ€ì´í•‘ í‘œì‹œ
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message bot';
            typingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
        }
        
        // ì±—ë´‡ ì‘ë‹µ (ë³µì›)
        function getBotResponse(message) {
            const lowerMessage = message.toLowerCase();
            // ì£¼ë¬¸ë²ˆí˜¸ íŒ¨í„´ í™•ì¸ (ìˆ«ìë¡œë§Œ êµ¬ì„±ëœ 6-12ìë¦¬)
            const orderNumberPattern = /^\d{6,12}$/;
            const orderNumberWithKeywordPattern = /^(\d{6,12})\s*(.*)$/;
            if (orderNumberWithKeywordPattern.test(message.trim())) {
                const match = message.trim().match(orderNumberWithKeywordPattern);
                const orderNumber = match[1];
                const keyword = match[2].trim();
                if (keyword.includes('í™˜ë¶ˆ') || keyword.includes('ë°˜í’ˆ')) {
                    return `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber}ì˜ í™˜ë¶ˆ(ë°˜í’ˆ) ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. 3ì¼ ì´ë‚´ í™˜ë¶ˆ ì²˜ë¦¬ ì˜ˆì •ì…ë‹ˆë‹¤.\n\nì¶”ê°€ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.`;
                } else if (keyword.includes('ë°°ì†¡')) {
                    return `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber}ì˜ ë°°ì†¡ ìƒíƒœëŠ” 'ë°°ì†¡ ì¤€ë¹„ ì¤‘'ì…ë‹ˆë‹¤. 1~2ì¼ ë‚´ ì¶œê³  ì˜ˆì •ì…ë‹ˆë‹¤.\n\në°°ì†¡ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.`;
                } else if (keyword.includes('ê²°ì œ')) {
                    return `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber}ì˜ ê²°ì œëŠ” ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê²°ì œ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.`;
                } else if (keyword.includes('êµí™˜')) {
                    return `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber}ì˜ êµí™˜ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹´ë‹¹ìê°€ ê³§ ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.`;
                } else if (keyword.length > 0) {
                    return `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber} ê´€ë ¨ ë¬¸ì˜(\"${keyword}\")ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ë‹´ë‹¹ìê°€ ê³§ ë‹µë³€ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.`;
                } else {
                    // í‚¤ì›Œë“œ ì—†ì´ ì£¼ë¬¸ë²ˆí˜¸ë§Œ ì…ë ¥í•œ ê²½ìš° ê¸°ì¡´ ëœë¤ ë‹µë³€
                    const responses = [
                        `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber}ë¡œ ì¡°íšŒí•œ ê²°ê³¼ì…ë‹ˆë‹¤:\n\nğŸ“¦ ë°°ì†¡ ìƒíƒœ: ë°°ì†¡ ì¤€ë¹„ ì¤‘\nğŸšš íƒë°°ì‚¬: CJëŒ€í•œí†µìš´\nğŸ“… ì˜ˆìƒ ë°°ì†¡ì¼: 1-2ì¼ ë‚´\n\nì¶”ê°€ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.`,
                        `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber} í™•ì¸ ì™„ë£Œ!\n\nâœ… ì£¼ë¬¸ ìƒíƒœ: ê²°ì œ ì™„ë£Œ\nğŸ“¦ ë°°ì†¡ ìƒíƒœ: ìƒí’ˆ ì¤€ë¹„ ì¤‘\nğŸ“ ë¬¸ì˜: 1588-0000\n\në„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”.`,
                        `ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber} ì¡°íšŒ ê²°ê³¼:\n\nğŸ›’ ì£¼ë¬¸ ìƒí’ˆ: ë‚˜ì´í‚¤ ì—ì–´ë§¥ìŠ¤\nğŸ’° ê²°ì œ ê¸ˆì•¡: 89,000ì›\nğŸ“… ì£¼ë¬¸ì¼: 2024ë…„ 7ì›” 1ì¼\n\në°°ì†¡ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.`
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
            }
            // ì£¼ë¬¸ë²ˆí˜¸ í˜•ì‹ì´ ì˜ëª»ëœ ê²½ìš°
            if (/^\d+$/.test(message.trim()) && (message.trim().length < 6 || message.trim().length > 12)) {
                return 'ì£¼ë¬¸ë²ˆí˜¸ëŠ” 6-12ìë¦¬ ìˆ«ìë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }
            if (lowerMessage.includes('ì£¼ë¬¸') && /\d/.test(message) && !orderNumberPattern.test(message.trim())) {
                return 'ì£¼ë¬¸ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 123456789)';
            }
            // ì£¼ë¬¸/ë°°ì†¡ ê´€ë ¨
            if (lowerMessage.includes('ì£¼ë¬¸') || lowerMessage.includes('ë°°ì†¡') || lowerMessage.includes('íƒë°°')) {
                const responses = [
                    'ì£¼ë¬¸í•˜ì‹  ìƒí’ˆì˜ ë°°ì†¡ ìƒíƒœë¥¼ í™•ì¸í•´ë“œë¦´ê¹Œìš”? ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
                    'ë°°ì†¡ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì£¼ë¬¸ë²ˆí˜¸ì™€ í•¨ê»˜ ë§ì”€í•´ì£¼ì„¸ìš”.',
                    'íƒë°° ì¶”ì ì´ í•„ìš”í•˜ì‹œë©´ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                    'ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì‹œë©´ ìƒì„¸í•œ ë°°ì†¡ ì •ë³´ë¥¼ í™•ì¸í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // í™˜ë¶ˆ/êµí™˜ ê´€ë ¨
            if (lowerMessage.includes('í™˜ë¶ˆ') || lowerMessage.includes('êµí™˜') || lowerMessage.includes('ë°˜í’ˆ')) {
                const responses = [
                    'í™˜ë¶ˆ/êµí™˜ ì‹ ì²­ì€ êµ¬ë§¤ í›„ 7ì¼ ì´ë‚´ì— ê°€ëŠ¥í•©ë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
                    'ìƒí’ˆì— ë¬¸ì œê°€ ìˆìœ¼ì‹œë©´ ì‚¬ì§„ê³¼ í•¨ê»˜ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
                    'í™˜ë¶ˆ ì‹ ì²­ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                    'êµí™˜/ë°˜í’ˆ ì‹ ì²­ì„ ìœ„í•´ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ì£¼ë¬¸ë²ˆí˜¸ ì¡°íšŒ ê´€ë ¨
            if (lowerMessage.includes('ì£¼ë¬¸ë²ˆí˜¸') || lowerMessage.includes('ì£¼ë¬¸ ë²ˆí˜¸') || lowerMessage.includes('ì£¼ë¬¸ ì¡°íšŒ') || lowerMessage.includes('ì¡°íšŒ')) {
                const responses = [
                    'ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì‹œë©´ ì£¼ë¬¸ ìƒíƒœì™€ ë°°ì†¡ ì •ë³´ë¥¼ í™•ì¸í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                    'ì£¼ë¬¸ë²ˆí˜¸ëŠ” 6-12ìë¦¬ ìˆ«ìë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                    'ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¡°íšŒí•˜ì‹œë ¤ë©´ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 123456789)',
                    'ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì‹œë©´ ìƒì„¸í•œ ì£¼ë¬¸ ì •ë³´ë¥¼ í™•ì¸í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                    'ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì‹œë©´ ë°°ì†¡ ìƒíƒœ, ê²°ì œ ì •ë³´, ìƒí’ˆ ì •ë³´ë¥¼ í•œ ë²ˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ê²°ì œ ê´€ë ¨
            if (lowerMessage.includes('ê²°ì œ') || lowerMessage.includes('ì¹´ë“œ') || lowerMessage.includes('ë¬´í†µì¥')) {
                const responses = [
                    'ê²°ì œ ë°©ë²•ì€ ì‹ ìš©ì¹´ë“œ, ê³„ì¢Œì´ì²´, ë¬´í†µì¥ì…ê¸ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
                    'ê²°ì œ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”.',
                    'ê²°ì œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì…¨ë‚˜ìš”? ì–´ë–¤ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ë‚˜ì™”ëŠ”ì§€ ì•Œë ¤ì£¼ì„¸ìš”.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ìƒí’ˆ ê´€ë ¨
            if (lowerMessage.includes('ìƒí’ˆ') || lowerMessage.includes('ì œí’ˆ') || lowerMessage.includes('ì‹ ë°œ')) {
                const responses = [
                    'ì–´ë–¤ ìƒí’ˆì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”? ìƒí’ˆëª…ì´ë‚˜ ë¸Œëœë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
                    'ìƒí’ˆ ì¬ê³  í™•ì¸ì´ í•„ìš”í•˜ì‹œë©´ ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                    'ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•´ë“œë¦´ê¹Œìš”?'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ì‚¬ì´ì¦ˆ ê´€ë ¨
            if (lowerMessage.includes('ì‚¬ì´ì¦ˆ') || lowerMessage.includes('í¬ê¸°') || lowerMessage.includes('fit')) {
                const responses = [
                    'ì‚¬ì´ì¦ˆ ê°€ì´ë“œë¥¼ í™•ì¸í•´ë“œë¦´ê¹Œìš”? í‰ì†Œ ì‹ ìœ¼ì‹œëŠ” ì‹ ë°œ ì‚¬ì´ì¦ˆë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
                    'ì‚¬ì´ì¦ˆ êµí™˜ì´ í•„ìš”í•˜ì‹œë©´ ì£¼ë¬¸ë²ˆí˜¸ì™€ í•¨ê»˜ ë§ì”€í•´ì£¼ì„¸ìš”.',
                    'ì‚¬ì´ì¦ˆ ì¶”ì²œì„ ë°›ê³  ì‹¶ìœ¼ì‹œë©´ ë°œ ê¸¸ì´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ê°€ê²© ê´€ë ¨
            if (lowerMessage.includes('ê°€ê²©') || lowerMessage.includes('ë¹„ìš©') || lowerMessage.includes('ì–¼ë§ˆ')) {
                const responses = [
                    'ìƒí’ˆ ê°€ê²©ì€ ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                    'íŠ¹ì • ìƒí’ˆì˜ ê°€ê²©ì„ ì•Œê³  ì‹¶ìœ¼ì‹œë©´ ìƒí’ˆëª…ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
                    'í• ì¸ ì •ë³´ë¥¼ í™•ì¸í•´ë“œë¦´ê¹Œìš”?'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // íšŒì›ê°€ì…/ë¡œê·¸ì¸ ê´€ë ¨
            if (lowerMessage.includes('íšŒì›ê°€ì…') || lowerMessage.includes('ë¡œê·¸ì¸') || lowerMessage.includes('ì•„ì´ë””')) {
                const responses = [
                    'íšŒì›ê°€ì…ì€ ìƒë‹¨ì˜ "íšŒì›ê°€ì…" ë²„íŠ¼ì„ í´ë¦­í•˜ì‹œë©´ ë©ë‹ˆë‹¤.',
                    'ë¡œê·¸ì¸ì— ë¬¸ì œê°€ ìˆìœ¼ì‹œë©´ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.',
                    'ì•„ì´ë”” ì°¾ê¸°ê°€ í•„ìš”í•˜ì‹œë©´ ê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ì„ ì•Œë ¤ì£¼ì„¸ìš”.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ì¸ì‚¬ë§
            if (lowerMessage.includes('ì•ˆë…•') || lowerMessage.includes('í•˜ì´') || lowerMessage.includes('hello')) {
                const responses = [
                    'ì•ˆë…•í•˜ì„¸ìš”! ì‹ ë°œ ê²½ë§¤ ì‚¬ì´íŠ¸ ì±—ë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?',
                    'ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”.',
                    'ì•ˆë…•í•˜ì„¸ìš”! ì£¼ë¬¸, ë°°ì†¡, í™˜ë¶ˆ, ìƒí’ˆ ë¬¸ì˜ ë“± ì–´ë–¤ ë¬¸ì˜ì‚¬í•­ì´ë“  ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ê°ì‚¬ ì¸ì‚¬
            if (lowerMessage.includes('ê°ì‚¬') || lowerMessage.includes('ê³ ë§ˆì›Œ') || lowerMessage.includes('thank')) {
                const responses = [
                    'ë„ì›€ì´ ë˜ì–´ì„œ ê¸°ì©ë‹ˆë‹¤! ë‹¤ë¥¸ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”.',
                    'ì²œë§Œì—ìš”! ë” í•„ìš”í•œ ê²ƒì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜í•´ì£¼ì„¸ìš”.',
                    'ê°ì‚¬í•©ë‹ˆë‹¤! ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”! ğŸ˜Š'
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            // ê¸°ë³¸ ì‘ë‹µ
            const defaultResponses = [
                'ì£„ì†¡í•©ë‹ˆë‹¤. ë” êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì‹œë©´ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                'ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ì‹ ì§€ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.',
                'ì£¼ë¬¸, ë°°ì†¡, í™˜ë¶ˆ, ìƒí’ˆ ë¬¸ì˜ ì¤‘ ì–´ë–¤ ê²ƒì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?',
                'ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”.',
                'ìƒë‹´ì› ì—°ê²°ì´ í•„ìš”í•˜ì‹œë©´ 1:1 ìƒë‹´ì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                'ì‹ ë°œ ê²½ë§¤ ì‚¬ì´íŠ¸ì—ì„œ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”!',
                'ì£¼ë¬¸í•˜ì‹  ìƒí’ˆì´ë‚˜ ë°°ì†¡, í™˜ë¶ˆ ë“± ì–´ë–¤ ë¬¸ì˜ì‚¬í•­ì´ë“  ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                'ë” ìì„¸í•œ ìƒë‹´ì´ í•„ìš”í•˜ì‹œë©´ 1:1 ìƒë‹´ì„ ì´ìš©í•´ë³´ì„¸ìš”.'
            ];
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }
        
        // ìƒë‹´ ì¢…ë£Œí•˜ê³  ë©”ì¸ìœ¼ë¡œ
        function goToMain() {
            window.location.href = '/';
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', function() {
            // ìƒë‹´ë°© ì…ì¥ ì‹œì ì— ì´ì „ í˜ì´ì§€ê°€ ë¡œê·¸ì¸/íšŒì›ê°€ì…/ìƒë‹´ë°©ì´ ì•„ë‹ˆë©´ ì €ì¥
            const prevUrl = document.referrer;
            if (prevUrl && !/login|member|chatRoom/.test(prevUrl)) {
                sessionStorage.setItem('prevChatPage', prevUrl);
            }
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            const endChatButton = document.getElementById('endChatButton');
            if (endChatButton) {
                endChatButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    // CSRF í† í° ì½ê¸°
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    // 1. ìƒë‹´ë°© ì™„ë£Œ ì²˜ë¦¬ ìš”ì²­
                    fetch(`/admin/chat/${chatRoomData.id}/complete`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            [csrfHeader]: csrfToken
                        }
                    }).finally(() => {
                        // 2. íŒì—…ì°½ì´ë©´ ë‹«ê¸°, ì•„ë‹ˆë©´ ì±„íŒ…ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
                        setTimeout(function() {
                            if (window.opener) {
                                window.close();
                                setTimeout(function() {
                                    if (!window.closed) {
                                        window.location.href = 'http://localhost/admin/chat/in-progress';
                                    }
                                }, 300);
                            } else {
                                window.location.href = 'http://localhost/admin/chat/in-progress';
                            }
                        }, 100);
                    });
                });
            }
            const userBackButton = document.getElementById('userBackButton');
            if (userBackButton) {
                userBackButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    // CSRF í† í° ì½ê¸°
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    fetch(`/chat/room/${chatRoomData.id}/delete`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            [csrfHeader]: csrfToken
                        }
                    }).finally(() => {
                        // íŒì—…ì°½ì´ë©´ ë‹«ê¸°, ì•„ë‹ˆë©´ ê¸°ì¡´ ì´ë™
                        setTimeout(function() {
                            if (window.opener) {
                                window.close();
                            } else {
                                const prev = sessionStorage.getItem('prevChatPage');
                                if (prev) {
                                    window.location.href = prev;
                                } else {
                                    window.location.href = '/';
                                }
                            }
                        }, 100);
                    });
                });
            }
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            if (chatRoomData.chatType === 'CHATBOT' || chatRoomData.chatType === 'ì±—ë´‡' || chatRoomData.chatType === 'ì±—ë´‡ìƒë‹´' || chatRoomData.chatType === '2') {
                // ì±—ë´‡ ìƒë‹´ë°©: WebSocket ì—°ê²°/êµ¬ë…/ì…ì¥ ë©”ì‹œì§€ ì „ì†¡ ë“± ì—†ìŒ
                setTimeout(() => {
                    const welcomeMessage = 'ì•ˆë…•í•˜ì„¸ìš”! ì‹ ë°œ ê²½ë§¤ ì‚¬ì´íŠ¸ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ¤–\n\nì£¼ë¬¸, ë°°ì†¡, í™˜ë¶ˆ, ìƒí’ˆ ë¬¸ì˜ ë“± ë¬´ì—‡ì´ë“  ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\nìì£¼ ë¬»ëŠ” ì§ˆë¬¸:\nâ€¢ ì£¼ë¬¸/ë°°ì†¡ ë¬¸ì˜ (ì£¼ë¬¸ë²ˆí˜¸ ì…ë ¥)\nâ€¢ í™˜ë¶ˆ/êµí™˜ ì‹ ì²­\nâ€¢ ê²°ì œ ë°©ë²• ì•ˆë‚´\nâ€¢ ìƒí’ˆ ì •ë³´ í™•ì¸\nâ€¢ ì‚¬ì´ì¦ˆ ê°€ì´ë“œ\n\nğŸ’¡ ì£¼ë¬¸ë²ˆí˜¸ë¡œ ë¹ ë¥¸ ì¡°íšŒê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤!\nê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ë¬¼ì–´ë³´ì„¸ìš”! ğŸ˜Š';
                    addMessage(welcomeMessage, 'bot', 'ì±—ë´‡');
                }, 500);
            } else {
                // 1:1 ìƒë‹´ WebSocket ì—°ê²°
                const socket = new SockJS('/ws');
                console.log("ì†Œì¼“:"+socket);
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function(frame) {
                    stompClient.subscribe('/topic/room/' + chatRoomData.id, function(message) {
                        const chatMessage = JSON.parse(message.body);
                        if (chatMessage.type === 'JOIN') {
                            if (chatMessage.message && chatMessage.message.trim() !== '') {
                                addMessage(chatMessage.message, chatMessage.senderType === 'ADMIN' ? 'admin' : 'user', chatMessage.sender);
                            }
                        } else if (chatMessage.type === 'MESSAGE') {
                            if (chatMessage.senderType === 'ADMIN') {
                                addMessage(chatMessage.message, 'admin', chatMessage.sender);
                            } else {
                                // ìœ ì € ë©”ì‹œì§€
                                const isCurrentUser = chatMessage.sender === currentUser;
                                addMessage(chatMessage.message, isCurrentUser ? 'user' : 'admin', chatMessage.sender);
                            }
                        }
                    });
                    // ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
                    setTimeout(() => {
                        stompClient.send("/app/chat.room.join", {}, JSON.stringify({
                            type: 'JOIN',
                            roomId: chatRoomData.id,
                            sender: currentUser,
                            message: '',
                            timestamp: new Date()
                        }));
                    }, 1000);
                }, function(error) {
                    console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                    addMessage('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'system');
                });
            }
        });
    </script>
</body>
</html> 