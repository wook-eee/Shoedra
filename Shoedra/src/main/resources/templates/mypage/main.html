<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function () {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            $(document).off("click", "#doSomethingBtn").on("click", "#doSomethingBtn", function (e) {
                e.preventDefault();
                console.log("버튼 클릭됨");

                $.ajax({
                    type: "POST",
                    url: "/admin/data",
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (res) {
                        alert("성공: " + res);
                    },
                    error: function (xhr) {
                        alert("실패: " + xhr.responseText);
                    }
                });
            });





        });

    </script>
</th:block>

<th:block layout:fragment="css">
    <style>
        .mypage-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .menu-item {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            text-align: center;
            transition: transform 0.2s;
        }
        .menu-item:hover {
            transform: translateY(-5px);
        }
        .menu-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</th:block>

<div layout:fragment="content">
    <div class="mypage-container">
        <h2 class="mb-4">마이페이지</h2>
        
        <!-- 성공 메시지 -->
        <div th:if="${param.success}" class="success-message">
            <span th:if="${param.success == 'profile'}">프로필이 성공적으로 수정되었습니다.</span>
            <span th:if="${param.success == 'password'}">비밀번호가 성공적으로 변경되었습니다.</span>
        </div>

        <!-- 프로필 정보 -->
        <div class="profile-card">
            <h4 class="mb-3">프로필 정보</h4>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>이름:</strong> <span th:text="${member.name}"></span></p>
                    <p><strong>이메일:</strong> <span th:text="${member.email}"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>전화번호:</strong> <span th:text="${member.phone}"></span></p>
                    <p><strong>주소:</strong> <span th:text="${member.address}"></span></p>
                </div>
            </div>
            <div class="mt-3">
                <a href="/mypage/profile" class="btn btn-primary">프로필 수정</a>

                <button id="doSomethingBtn" sec:authorize="hasRole('ROLE_ADMIN')">실행</button>
            </div>
        </div>

        <!-- 메뉴 그리드 -->
        <div class="menu-grid">
            <!-- 입찰내역/낙찰내역 카드 추가 -->
            <div class="menu-item">
                <div class="menu-icon">📈</div>
                <h5>입찰 내역</h5>
                <p class="text-muted">내가 입찰한 내역 확인</p>
                <a href="/mypage/bid-history" class="btn btn-outline-primary">입찰내역</a>
            </div>
            <div class="menu-item">
                <div class="menu-icon">🏆</div>
                <h5>낙찰 내역</h5>
                <p class="text-muted">내가 낙찰받은 내역 확인</p>
                <a href="/mypage/win-history" class="btn btn-outline-primary">낙찰내역</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">🔒</div>
                <h5>비밀번호 변경</h5>
                <p class="text-muted">보안을 위한 비밀번호 변경</p>
                <a href="/mypage/password" class="btn btn-outline-primary">변경하기</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">💰</div>
                <h5>캐시 관리</h5>
                <p class="text-muted">캐시 충전 및 내역 확인</p>
                <a href="/cash" class="btn btn-outline-primary">캐시 관리</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">📦</div>
                <h5>주문 내역</h5>
                <p class="text-muted">구매한 상품 내역 확인</p>
                <a href="/orders" class="btn btn-outline-primary">주문 내역</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">🛒</div>
                <h5>장바구니</h5>
                <p class="text-muted">담아둔 상품 확인</p>
                <a href="/cart" class="btn btn-outline-primary">장바구니</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">📅</div>
                <h5>일정 관리</h5>
                <p class="text-muted">캘린더 일정 확인</p>
                <a href="/calendar" class="btn btn-outline-primary">일정 보기</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">💬</div>
                <h5>1:1채팅</h5>
                <p class="text-muted">회원간 1:1 채팅</p>
<!--                <a href="/mypage/chat" class="btn btn-outline-primary">1:1채팅</a>-->
                <button class="chat-btn" onclick="createOneOnOneChat()">
                    <i class="fas fa-comments"></i>
                    <span>1:1 상담</span>
                </button>
                <button class="chat-btn" onclick="createBotChat()">
                    <i class="fas fa-robot"></i>
                    <span>챗봇 상담</span>
                </button>
            </div>

            <!-- 관리자 섹션 (관리자만 표시) -->
            <section th:if="${#authorization.expression('hasRole(''ADMIN'')')}" class="admin-section">
                <h2>관리자 메뉴</h2>
                <p>상담 관리 및 시스템 관리</p>
                <div style="margin-top: 1rem;">
                    <a href="/admin/chat/in-progress" class="admin-btn" style="margin-left: 1rem;">
                        <i class="fas fa-comments"></i>
                        진행 중인 상담 관리
                    </a>
                </div>
            </section>
        </div>
        <th:block layout:fragment="script">
            <script>
                function createBotChat() {
                    console.log("ㅎㅇ");
                    const isAuthenticated = [[${#authorization.expression('isAuthenticated()')}]];
                    if (!isAuthenticated) {
                        alert('상담을 이용하려면 로그인이 필요합니다.');
                        window.location.href = '/members/login';
                        return;
                    }
                    // CSRF 토큰 읽기
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    fetch('/chat/bot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    })
                    .then(response => response.text())
                    .then(result => {
                        if (result !== 'error') {
                            window.open('/chat/room/' + result, '_blank', 'width=500,height=700,resizable=yes,scrollbars=yes');
                        } else {
                            alert('상담 시작에 실패했습니다.');
                        }
                    });
                }

                function createOneOnOneChat() {
                    // 로그인 여부 확인
                    const isAuthenticated = [[${#authorization.expression('isAuthenticated()')}]];
                    if (!isAuthenticated) {
                        alert('상담을 이용하려면 로그인이 필요합니다.');
                        window.location.href = '/members/login';
                        return;
                    }
                    // CSRF 토큰 읽기
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    fetch('/chat/one-on-one', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    })
                    .then(response => response.text())
                    .then(result => {
                        if (result !== 'error') {
                            // 채팅방을 새 창(팝업)으로 오픈
                            window.open('/chat/room/' + result, '_blank', 'width=500,height=700,resizable=yes,scrollbars=yes');
                        } else {
                            alert('상담 시작에 실패했습니다.');
                        }
                    });
                }
            </script>
        </th:block>

        <!-- 회원 탈퇴 -->
        <div class="mt-4 text-center">
            <a href="/mypage/withdraw" class="btn btn-outline-danger">회원 탈퇴</a>
        </div>
    </div>
</div>
</html> 