<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function () {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            $(document).off("click", "#doSomethingBtn").on("click", "#doSomethingBtn", function (e) {
                e.preventDefault();
                console.log("ë²„íŠ¼ í´ë¦­ë¨");

                $.ajax({
                    type: "POST",
                    url: "/admin/data",
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (res) {
                        alert("ì„±ê³µ: " + res);
                    },
                    error: function (xhr) {
                        alert("ì‹¤íŒ¨: " + xhr.responseText);
                    }
                });
            });





        });

    </script>
</th:block>

<th:block layout:fragment="css">
    <style>
        .mypage-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .menu-item {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            text-align: center;
            transition: transform 0.2s;
        }
        .menu-item:hover {
            transform: translateY(-5px);
        }
        .menu-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</th:block>

<div layout:fragment="content">
    <div class="mypage-container">
        <h2 class="mb-4">ë§ˆì´í˜ì´ì§€</h2>
        
        <!-- ì„±ê³µ ë©”ì‹œì§€ -->
        <div th:if="${param.success}" class="success-message">
            <span th:if="${param.success == 'profile'}">í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
            <span th:if="${param.success == 'password'}">ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
        </div>

        <!-- í”„ë¡œí•„ ì •ë³´ -->
        <div class="profile-card">
            <h4 class="mb-3">í”„ë¡œí•„ ì •ë³´</h4>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ì´ë¦„:</strong> <span th:text="${member.name}"></span></p>
                    <p><strong>ì´ë©”ì¼:</strong> <span th:text="${member.email}"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>ì „í™”ë²ˆí˜¸:</strong> <span th:text="${member.phone}"></span></p>
                    <p><strong>ì£¼ì†Œ:</strong> <span th:text="${member.address}"></span></p>
                </div>
            </div>
            <div class="mt-3">
                <a href="/mypage/profile" class="btn btn-primary">í”„ë¡œí•„ ìˆ˜ì •</a>

                <button id="doSomethingBtn" sec:authorize="hasRole('ROLE_ADMIN')">ì‹¤í–‰</button>
            </div>
        </div>

        <!-- ë©”ë‰´ ê·¸ë¦¬ë“œ -->
        <div class="menu-grid">
            <!-- ì…ì°°ë‚´ì—­/ë‚™ì°°ë‚´ì—­ ì¹´ë“œ ì¶”ê°€ -->
            <div class="menu-item">
                <div class="menu-icon">ğŸ“ˆ</div>
                <h5>ì…ì°° ë‚´ì—­</h5>
                <p class="text-muted">ë‚´ê°€ ì…ì°°í•œ ë‚´ì—­ í™•ì¸</p>
                <a href="/mypage/bid-history" class="btn btn-outline-primary">ì…ì°°ë‚´ì—­</a>
            </div>
            <div class="menu-item">
                <div class="menu-icon">ğŸ†</div>
                <h5>ë‚™ì°° ë‚´ì—­</h5>
                <p class="text-muted">ë‚´ê°€ ë‚™ì°°ë°›ì€ ë‚´ì—­ í™•ì¸</p>
                <a href="/mypage/win-history" class="btn btn-outline-primary">ë‚™ì°°ë‚´ì—­</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">ğŸ”’</div>
                <h5>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h5>
                <p class="text-muted">ë³´ì•ˆì„ ìœ„í•œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</p>
                <a href="/mypage/password" class="btn btn-outline-primary">ë³€ê²½í•˜ê¸°</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">ğŸ’°</div>
                <h5>ìºì‹œ ê´€ë¦¬</h5>
                <p class="text-muted">ìºì‹œ ì¶©ì „ ë° ë‚´ì—­ í™•ì¸</p>
                <a href="/cash" class="btn btn-outline-primary">ìºì‹œ ê´€ë¦¬</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">ğŸ“¦</div>
                <h5>ì£¼ë¬¸ ë‚´ì—­</h5>
                <p class="text-muted">êµ¬ë§¤í•œ ìƒí’ˆ ë‚´ì—­ í™•ì¸</p>
                <a href="/orders" class="btn btn-outline-primary">ì£¼ë¬¸ ë‚´ì—­</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">ğŸ›’</div>
                <h5>ì¥ë°”êµ¬ë‹ˆ</h5>
                <p class="text-muted">ë‹´ì•„ë‘” ìƒí’ˆ í™•ì¸</p>
                <a href="/cart" class="btn btn-outline-primary">ì¥ë°”êµ¬ë‹ˆ</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">ğŸ“…</div>
                <h5>ì¼ì • ê´€ë¦¬</h5>
                <p class="text-muted">ìº˜ë¦°ë” ì¼ì • í™•ì¸</p>
                <a href="/calendar" class="btn btn-outline-primary">ì¼ì • ë³´ê¸°</a>
            </div>

            <div class="menu-item">
                <div class="menu-icon">ğŸ’¬</div>
                <h5>1:1ì±„íŒ…</h5>
                <p class="text-muted">íšŒì›ê°„ 1:1 ì±„íŒ…</p>
<!--                <a href="/mypage/chat" class="btn btn-outline-primary">1:1ì±„íŒ…</a>-->
                <button class="chat-btn" onclick="createOneOnOneChat()">
                    <i class="fas fa-comments"></i>
                    <span>1:1 ìƒë‹´</span>
                </button>
                <button class="chat-btn" onclick="createBotChat()">
                    <i class="fas fa-robot"></i>
                    <span>ì±—ë´‡ ìƒë‹´</span>
                </button>
            </div>

            <!-- ê´€ë¦¬ì ì„¹ì…˜ (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
            <section th:if="${#authorization.expression('hasRole(''ADMIN'')')}" class="admin-section">
                <h2>ê´€ë¦¬ì ë©”ë‰´</h2>
                <p>ìƒë‹´ ê´€ë¦¬ ë° ì‹œìŠ¤í…œ ê´€ë¦¬</p>
                <div style="margin-top: 1rem;">
                    <a href="/admin/chat/in-progress" class="admin-btn" style="margin-left: 1rem;">
                        <i class="fas fa-comments"></i>
                        ì§„í–‰ ì¤‘ì¸ ìƒë‹´ ê´€ë¦¬
                    </a>
                </div>
            </section>
        </div>
        <th:block layout:fragment="script">
            <script>
                function createBotChat() {
                    console.log("ã…ã…‡");
                    const isAuthenticated = [[${#authorization.expression('isAuthenticated()')}]];
                    if (!isAuthenticated) {
                        alert('ìƒë‹´ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = '/members/login';
                        return;
                    }
                    // CSRF í† í° ì½ê¸°
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    fetch('/chat/bot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    })
                    .then(response => response.text())
                    .then(result => {
                        if (result !== 'error') {
                            window.open('/chat/room/' + result, '_blank', 'width=500,height=700,resizable=yes,scrollbars=yes');
                        } else {
                            alert('ìƒë‹´ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
                }

                function createOneOnOneChat() {
                    // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
                    const isAuthenticated = [[${#authorization.expression('isAuthenticated()')}]];
                    if (!isAuthenticated) {
                        alert('ìƒë‹´ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = '/members/login';
                        return;
                    }
                    // CSRF í† í° ì½ê¸°
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    fetch('/chat/one-on-one', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    })
                    .then(response => response.text())
                    .then(result => {
                        if (result !== 'error') {
                            // ì±„íŒ…ë°©ì„ ìƒˆ ì°½(íŒì—…)ìœ¼ë¡œ ì˜¤í”ˆ
                            window.open('/chat/room/' + result, '_blank', 'width=500,height=700,resizable=yes,scrollbars=yes');
                        } else {
                            alert('ìƒë‹´ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
                }
            </script>
        </th:block>

        <!-- íšŒì› íƒˆí‡´ -->
        <div class="mt-4 text-center">
            <a href="/mypage/withdraw" class="btn btn-outline-danger">íšŒì› íƒˆí‡´</a>
        </div>
    </div>
</div>
</html> 