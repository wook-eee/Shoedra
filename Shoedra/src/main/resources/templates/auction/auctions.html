<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="UTF-8">
    <title></title>
<!-- í•´ë‹¹í˜ì´ì§€ css import   -->
<!--    <link th:href="@{/css/test.css}" rel="stylesheet">-->
</head>
<!--ìŠ¤í¬ë¦½íŠ¸-->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        let page = 0;
  const size = 8;
  let isLoading = false;
  let isLastPage = false;

  function getStatusText(state) {
    switch (state) {
      case 'READY': return 'ê²½ë§¤ì „';
      case 'IN_PROGRESS': return 'ê²½ë§¤ì¤‘';
      case 'ENDED': return 'ê²½ë§¤ë§ˆê°';
      default: return 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
  }

  function createAuctionCard(auction) {
    return `
      <a href="/auction/${auction.id}" class="auction-card">
        <img src="${auction.repImgUrl}" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="auction-img">
        <h3>${auction.itemName}</h3>
        <p>ì‹œì‘ê°€: ${auction.startPrice}ì›</p>
        <p>í˜„ì¬ê°€: ${auction.currentBidPrice}ì›</p>
        <p class="auction-status ${auction.auctionState}">${getStatusText(auction.auctionState)}</p>
      </a>
    `;
  }

  function loadAuctions() {
    if (isLoading || isLastPage) return;
    isLoading = true;

    fetch(`/auction/auctions/load?page=${page}&size=${size}`)
      .then(res => res.json())
      .then(data => {
        console.log("â–¶ í˜ì´ì§€:", page, "| ë§ˆì§€ë§‰ í˜ì´ì§€? ", data.last);

        if (data.content.length === 0 && page === 0) {
          document.getElementById('auctionGrid').innerHTML =
            '<div style="text-align:center;padding:2rem;">ë“±ë¡ëœ ê²½ë§¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          isLastPage = true;
          return;
        }

        const grid = document.getElementById('auctionGrid');
        data.content.forEach(auction => {
          grid.insertAdjacentHTML('beforeend', createAuctionCard(auction));
        });

        if (data.last) {
          isLastPage = true;
          observer.disconnect();
        } else {
          page++;
        }
      })
      .finally(() => {
        isLoading = false;
      });
  }

  let observer;

  document.addEventListener('DOMContentLoaded', () => {
    loadAuctions();

    const sentinel = document.getElementById('sentinel');
    if (!sentinel) {
        console.error("sentinel ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // observerê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ disconnect (ì¤‘ë³µ ê°ì§€ ë°©ì§€)
    if (observer) observer.disconnect();

    observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting && !isLoading && !isLastPage) {
          loadAuctions();
        }
    });

    observer.observe(sentinel);

     requestAnimationFrame(() => {
        const rect = sentinel.getBoundingClientRect();
        if (rect.top < window.innerHeight && !isLoading && !isLastPage) {
          loadAuctions();
        }
      });
  });
    </script>
</th:block>
<!--css-->
<th:block layout:fragment="css">
    <style>
        #auctionWrapper {
          min-height: 100vh; /* ğŸ”¥ ë¸Œë¼ìš°ì € ë†’ì´ë§Œí¼ í™•ë³´í•´ì„œ sentinel ê°ì§€ í™•ë¥  ì¦ê°€ */
          display: flex;
          flex-direction: column;
        }
        .auction-grid {
          max-width: 1280px;     /* header-inner ê¸°ì¤€ */
          margin: 0 auto;         /* ê°€ìš´ë° ì •ë ¬ */
          padding: 2rem;
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
          gap: 2rem;
          background-color: #f8f9fa;
          flex-grow: 1;
        }

        /* ê²½ë§¤ ì¹´ë“œ */
        .auction-card {
          background-color: #fff;
          border-radius: 12px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.05);
          padding: 1.2rem;
          transition: transform 0.2s ease, box-shadow 0.3s ease;
          display: flex;
          flex-direction: column;
          align-items: center;
          text-decoration: none;
        }

        .auction-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        /* ì´ë¯¸ì§€ */
        .auction-card img {
          width: 100%;
          height: 180px;
          object-fit: cover;
          border-radius: 8px;
          margin-bottom: 1rem;
        }

        /* ì œëª© */
        .auction-card h3 {
          font-size: 1.1rem;
          font-weight: 600;
          margin-bottom: 0.5rem;
          text-align: center;
        }

        /* í…ìŠ¤íŠ¸ ì •ë³´ */
        .auction-card p {
          font-size: 0.95rem;
          color: #555;
          margin: 0.25rem 0;
        }

        .auction-status {
          font-weight: bold;
          padding: 0.3rem 0.7rem;
          border-radius: 20px;
          font-size: 0.85rem;
          margin-top: 0.5rem;
          text-align: center;
        }

        /* ìƒíƒœë³„ ìƒ‰ìƒ êµ¬ë¶„ */
        .auction-status.BEFORE {
          color: #856404;
          background-color: #fff3cd;
        }

        .auction-status.IN_PROGRESS {
          color: #155724;
          background-color: #d4edda;
        }

        .auction-status.CLOSED {
          color: #721c24;
          background-color: #f8d7da;
        }

        #sentinel {
          height: 100px;  /* ìµœì†Œí•œ 50~100pxì€ ì¤˜ì•¼ ê°ì§€ë¨ */
        }
    </style>
</th:block>

<div layout:fragment="content">
    <div id="auctionWrapper">
        <div id="auctionGrid" class="auction-grid">
            <!-- ê²½ë§¤ ì¹´ë“œê°€ ì—¬ê¸°ì— ë¬´í•œ ì¶”ê°€ë¨ -->
        </div>

        <!-- ìŠ¤í¬ë¡¤ ë ê°ì§€ìš© -->
        <div id="sentinel"></div>
    </div>
</div>
</html>
